with aaa as

(
SELECT 
		 D_PODMIOT
		,DF_EVALUATED_VALUE
		,P_REGON
		,P_NIP
		,P_SYS_CENTER_ID
		,P_NAZWA
		,D_TO_DATE
		,CAST(O1.O_OKRES_DO AS DATE) ZA_DATE
		,DTF_ABSTRACT
		,P_CZY_INNY_ROK_OBRACHUNKOWY
		,D_MONTHS_NUMBER
		,D1.DII_NAME RATING_KLIENTA_SYSTEM
		,D2.DII_NAME RATING_KLIENTA_SYSTEM_DOK
		,ISNULL(D1.DII_NAME,D2.DII_NAME) RATING_KLIENTA_OST
		,D3.DII_NAME								RATING_KLIENTA_DME

FROM
SDMO_PODMIOT P1
inner join SDMO_ANALIZA_PODMIOTU AP1 on AP1.AP_PODMIOT = P1.P_ID
LEFT JOIN  SDMO_OCENA O1 ON O1.O_ANALIZA = AP1.AP_ID
inner join SDMO_RATING_KLIENTA RK on RK_OCENA = O1.O_ID
LEFT JOIN SDMO_MONITORING MMM ON P_ID = M_PODMIOT AND M_ANALIZA_PODMIOTU = AP1.AP_PODMIOT
LEFT JOIN SDMO_OCENA_DOKUMENT ON OD_OCENA=O_ID
LEFT JOIN SDMO_DOCUMENT ON D_ID=OD_DOKUMENT
LEFT JOIN SDMO_DOCUMENT_FIELD ON DF_DOCUMENT=D_ID
LEFT JOIN SDMO_DOCUMENT_TEMPLATE_FIELD ON DTF_ID=DF_TEMPLATE
LEFT JOIN SDMO_DOCUMENT_ABSTRACT ON DTF_ABSTRACT=DA_ID
LEFT JOIN SDMO_DOCUMENT_TEMPLATE ON DTF_DOCUMENT_TEMPLATE=DT_ID
LEFT JOIN	DIC_ITEM D1	ON RK.RK_RATING_KLIENTA_SYSTEM = D1.DII_ID
LEFT JOIN	DIC_ITEM D2	ON RK.RK_RATING_KLIENTA_SYSTEM_DOK = D2.DII_ID
LEFT JOIN	DIC_ITEM D3	ON MMM.M_PROPONOWANY_RATING_DYREKTORA_CK = D3.DII_ID 


WHERE 
DTF_ABSTRACT IN ('724','762','582','586','587','641','652','658','659','661','669','714','719','730','734','737','738','739','740','741','742','743','1020','1021','1022','1035','1036','1037','1041','1042','1047','1051')
 --rodzaje pól które maja byæ pobrane ze sprawozdañ finansowych
AND D_TYPE='08D4B1B8-E8FA-41B9-B159-7F2822106789'  ---okres sprawozdawczy
AND D_STATUS='DC84AD70-1F90-478A-A765-364BFDCBE31D' ---status zaakceptowany
--AND D_MONTHS_NUMBER=12
AND YEAR(D_TO_DATE) BETWEEN 2018 and 2022
AND P_REGON IS NOT NULL
AND P_REGON !=''
AND P_REGON !=' '
--AND P_REGON='220836805'
--GROUP BY D_PODMIOT ,DF_EVALUATED_VALUE ,P_REGON,D_TO_DATE, DTF_ABSTRACT, P_NAZWA, P_NIP, P_SYS_CENTER_ID, P_CZY_INNY_ROK_OBRACHUNKOWY,D_MONTHS_NUMBER
)

		/*bbb as
		(select 
				 D_PODMIOT
				,DTF_ABSTRACT
				,MAX(D_MADE_DATE) dd
		 from
				 aaa
		 group by D_PODMIOT, DTF_ABSTRACT)*/


select
		 aaa.DF_EVALUATED_VALUE
		,aaa.P_REGON
		,aaa.P_NAZWA
		,aaa.DTF_ABSTRACT
		,aaa.P_NIP
		,aaa.P_SYS_CENTER_ID
		,aaa.P_CZY_INNY_ROK_OBRACHUNKOWY
		,aaa.D_MONTHS_NUMBER
		,aaa.D_TO_DATE
		,aaa.ZA_DATE
		,aaa.RATING_KLIENTA_SYSTEM
		,aaa.RATING_KLIENTA_SYSTEM_DOK
		,aaa.RATING_KLIENTA_OST
INTO ##TEST
from
aaa 
--inner join bbb on aaa.D_PODMIOT=bbb.D_PODMIOT and aaa.D_MADE_DATE=bbb.dd
--and aaa.DTF_ABSTRACT=bbb.DTF_ABSTRACT
--where P_REGON='220836805'

	SELECT
			 P_REGON
			,P_NIP
			,P_SYS_CENTER_ID ID_KL_DEF
			,D_MONTHS_NUMBER
			,ZA_DATE
			,RATING_KLIENTA_SYSTEM
			,RATING_KLIENTA_SYSTEM_DOK
			,RATING_KLIENTA_OST
			,CAST(D_TO_DATE AS DATE) AS D_TO_DATE
			,Replace(Replace(Replace(P_NAZWA, Char(10), ''),Char(13), ''),Char(9), '') as 'Nazwa podmiotu'
			--,DF_EVALUATED_VALUE
			--,DTF_ABSTRACT
			,COALESCE(CAST([724] as float),CAST([762] as float)) as 'przychody'
			,[582] AS K1,
			[586] AS K2,
			[587] AS K3,
			[641] AS K4,
			[652] AS K5,
			[658] AS K6,
			[659] AS K7,
			[661] AS K8,
			[669] AS K9,
			[714] AS K10,
			[719] AS K11,
			[730] AS K12,
			[734] AS K13,
			[737] AS K14,
			[738] AS K15,
			[739] AS K16,
			[740] AS K17,
			[741] AS K18,
			[742] AS K19,
			[743] AS K20,
			[1020] AS K21,
			[1021] AS K22,
			[1022] AS K23,
			[1035] AS K24,
			[1036] AS K25,
			[1037] AS K26,
			[1041] AS K27,
			[1042] AS K28,
			[1047] AS K29,
			[1051] AS K30
			--,convert (float,[724]) 'Przychody ze sprzedazy'
			--,CAST([762] as float) 'Przychody_v2'
	INTO ##PVT FROM ##TEST
	PIVOT 
	(SUM(DF_EVALUATED_VALUE) FOR DTF_ABSTRACT IN ([724],[762],[582],[586],[587],[641],[652],[658],[659],[661],[669],[714],[719],[730],[734],[737],[738],[739],[740],[741],[742],[743],[1020],[1021],[1022],[1035],[1036],[1037],[1041],[1042],[1047],[1051]))as pvt

DROP TABLE ##TEST

SELECT * FROM ##PVT

DROP TABLE ##PVT
